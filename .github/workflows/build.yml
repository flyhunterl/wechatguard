name: Build WeChatGuard Executable

on:
  push:
    tags:
    - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v3
      with:
        python-version: 3.9
    
    - run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller setuptools wheel
    
    - id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
    
    - run: |
        version="${{ steps.version.outputs.version }}"
        version_parts=(${version#v})
        IFS='.' read -r major minor patch <<< "$version_parts"
        major=${major:-1}
        minor=${minor:-0}
        patch=${patch:-0}
        
        cat > version_info.txt << EOL
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=($major, $minor, $patch, 0),
    prodvers=($major, $minor, $patch, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo(
      [
        StringTable(
          '040904B0',
          [
            StringEntry('CompanyName', '个人开发'),
            StringEntry('FileDescription', 'WeChat Guardian - 微信守护程序'),
            StringEntry('FileVersion', '$major.$minor.$patch.0'),
            StringEntry('InternalName', 'WeChatGuard'),
            StringEntry('LegalCopyright', ' 2024 个人开发'),
            StringEntry('OriginalFilename', 'WeChatGuard.exe'),
            StringEntry('ProductName', 'WeChat Guardian'),
            StringEntry('ProductVersion', '$major.$minor.$patch.0')
          ]
        )
      ]
    ),
    VarFileInfo([VarEntry('Translation', [2052, 1200])])
  ]
)
EOL
    
    - run: >
        pyinstaller 
        --onefile 
        --windowed 
        --icon=src/icon/app_icon.ico 
        --name="WeChatGuard_${{ steps.version.outputs.version }}" 
        --version-file=version_info.txt 
        src/main.py
    
    - uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: dist/WeChatGuard_*.exe
        body: |
          ## 更新日志
          - 版本：${{ steps.version.outputs.version }}
